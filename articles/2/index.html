<!DOCTYPE html>
<html lang="en">
<head>
    <title>The puzzling MQ-x sensor series</title>
    <meta charset="UTF-8">
    <meta name="description" content="Use an MQ-7 sensor with an Arduino">

    <link rel="stylesheet" href="../../style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0">
    <script src="../../js/position_hack.js"></script>
    <script src="../../js/page_manager.js"></script>
    <script>
        const pm = new PageManager(4);
    </script>
</head>

<body>
    <h1>The puzzling MQ-x sensor series</h1>

    When choosing a gas sensor, there's nothing as cheap as an MQ-x series sensor. I decided to buy (for an incoming project) an MQ-7 and an MQ-135 for a grand total of 4.78&euro;. Let's see if I can make them work.

    <div id="page0" class="page">
        <h2>0. The working principle</h2>

        <img src="img/mq7.svg" loading="lazy" style="float:right;width:15em;" alt="MQ-7 sensor">
        
        The MQ-7 sensitive layer is made of \(SnO_2\). In the presence of \(CO\) (the gas concentration we want to measure) the following reaction happens:
        \[{SnO_2}_{(s)} + 2CO_{(g)} \rightleftharpoons Sn_{(s)} + {2CO_2}_{(g)}\]

        This means that the more \(CO\) in the air, the more \(SnO_2\) gets converted to \(Sn\). I'm not a chemist, but usually the purer a metal is, the lower is its resistivity. In layman's terms: when the concentration of \(CO\) raises, the sensor sensitive layer resistance lowers.
        <br><br>
        The problem now is: what happens when all the \(SnO_2\) gets converted to \(Sn\)? Notice the double-sided arrow in the previous reaction, because it means it's reversibile.
        <br>
        Chemists defined the so-called <i>equilibrium constant</i> \(K_c\). When \(K_c>>1\) the reaction equilibrium is shifted to the right side of the equation, meaning that the predominant reaction is the one that gives us the products. The opposite happens if \(K_c&lt;&lt;1\). With this reaction we are in the first case, meaning that:
        <ul>
            <li>\(SnO_2\) is converted (with no effort) to \(Sn\)</li>
            <li>To reverse the reaction, we need to expend energy</li>
        </ul>
        That's where another sensor's element comes in handy: the heater. Again, I'm not a chemist, so don't quote me on this, but said forward reaction is exothermic (it releases heat), hence rising the sensor internal temperature means reversing the reaction, converting \(Sn\) back to \(SnO_2\).
        This is, in fact, supported by the fifth figure in the <a href="img/MQ-7.pdf">datasheet</a>:
        <img src="img/fig5.webp" loading="lazy" style="width:50em;" alt="heater cycle">

        To sum up, we need to:
        <ol>
            <li>Heat the heater at \(5V\)</li>
            <li>Wait \(60s\) to &quot;clean&quot; the sensor</li>
            <li>Drop the heater voltage at \(1.4V\)</li>
            <li>Keep that voltage steady for \(90s\)</li>
            <li>Read the sensor resistance right before the end of the \(90s\)-period</li>
        </ol>
    </div>

    <div id="page1" class="page">
        <h2>1. The dual voltage problem</h2>
        The first problem we need to face is the heater dual \(5V-1.4V\) voltage requirement. People decided to solve this issue by:
        <ol>
            <li>
                &#x274C; Using the <i>ostrich attitude</i>, <b>continuously providing \(5V\) to the heater</b>. 
                This is just utterly wrong: they are violating the sensor specs and that's bad.
            </li>
            <li>
                &#x274C; Generate a <b>PWM signal at \(1.4V\)</b> with Arduino.
                This is not wrong per se, but you need to be very careful if you choose this option because:
                <ul>
                    <li>The heater consumes \(70mA\) at \(5V\) and Arduino can't stand this much current</li>
                    <li>The heater needs a steady voltage, so the the PWM signal needs to be filtered</li>
                </ul>
            </li>
            <li>&#x2714; Use a custom circuit to switch between the two voltages</li>
        </ol>

        <h3>1.1. The real solution</h3>
        <img src="img/divider.svg" loading="lazy" style="float:right;width:30em;" alt="driver circuit">
        We can grab the \(5V\) from the same power supply used for the Arduino, but what about the \(1.4V\) voltage? We can use a voltage divider:
        \[5V\frac{R_2}{R_1+R_2}=V_H=1.4V \Longrightarrow \frac{R_1}{R_2}\approx 2.57\]
        We know, from the <a href="img/MQ-7.pdf">datasheet</a>, that the heater has a resistance of \(33\Omega\). Hence, if we choose \(R_2=33\Omega\):
        \[R_1=2.57\cdot33\Omega\approx 85\Omega\]
        Which can be approximated to the closest standard value of \(82\Omega\). We also need \(V_H=5V\)! The solution is to simply short-circuit \(R_1\) with a transistor. We can use an nMOS since it has a much smaller \(R_{DS}\) than a BJT.
        <br><br>
        Now everything is fine, but we might want to switch the MOSFET on and off both from a \(5V\) board and a \(3.3V\) one. We need a BJT, obtaining the circuit in the figure.
        I also added \(R_4\) to limit the base current of the BJT and \(R_3\) as a pullup resistor.
        <br><br>
        To sum up:
        <ul>
            <li>When the input is <b>high</b>, \(Q_1\) is &quot;on&quot;, \(M_1\) drain is held low, \(M_1\) is &quot;off&quot;, \(V_H=1.4V\)</li>
            <li>When the input is <b>low</b>, \(Q_1\) is &quot;off&quot;, \(M_1\) drain is held high, \(M_1\) is &quot;on&quot;, \(V_H=5V\)</li>
        </ul>
    </div>

    <div id="page2" class="page">
        <h2>2. Throwing the PCB away</h2>
        Another problem we need to address is the sensor PCB: it's just bad (remember the <i>ostrich attitude</i>?). Have a look:
        <img src="img/module_circ.webp" loading="lazy" style="width:50vw" alt="module circuit">
        <img src="img/module.webp" loading="lazy" style="float:right;width:20%;" alt="module">
        Everything on the right side of \(R_2\) is useless: \(U1A\) is a comparator which drives \(DOUT\) high or low, depending on the adjustable voltage on the \(+\) pin. On \(DOUT\) there's also an LED because why not?
        <br>
        The \(VCC\) wirings make this design even worse. Notice how \(VCC\) is used for the heater, the comparator voltage reference and the comparator supply. Now keep in mind that the heater voltage needs to change between \(1.4V\) and \(5V\), hence \(VCC\) changes between \(1.4V\) and \(5V\), meaning that the comparator voltage reference and supply both change over time.
        <br><br>
        Outraged, I decided to simply desolder the sensor.
        If you decide to follow my same path please be cautious not to overheat the sensor with your soldering iron.
    </div>

    <div id="page3" class="page">
        <h2>3. Testing the new driver</h2>
        This is what I ended up with:
        <img src="img/breadboard.webp" loading="lazy" style="width:80%" alt="breadboard circuit">
        To calibrate the \(1.4V\) voltage:
        <ol>
            <li>Measure the voltage between the sensor heater terminals</li>
            <li>Move the \(IN\) jumper to \(5V\)</li>
            <li>Rotate the trimmer to adjust the voltage at around \(1.4V\)</li>
        </ol>
    </div>

    <div id="page4" class="page">
        <h2>4. Reading the sensor</h2>
        
    </div>

    <div id="navigation-bar">
        <a href="#" onclick="pm.prevPage();" id="navigate-left">&lt;&lt; Previous</a>
        <a href="#" onclick="pm.nextPage();" id="navigate-right">Next &gt;&gt;</a>
    </div>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</body>
</html>