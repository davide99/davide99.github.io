<html>
<head>
    <title>The puzzling MQ-x sensor series</title>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="../../style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <script src="../../js/position_hack.js"></script>
    <script>
        var page = 0;
        const last_page = 1;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("page"))
            page = parseInt(urlParams.get("page"));

        function nextPage() {
            if (page === last_page)
                page = 0;
            else
                page++;
        }

        function prevPage() {
            if (page === 0)
                page = last_page;
            else
                page--;
        }

        function showPage() {
            Array.from(document.getElementsByClassName("page")).forEach(function(element, index, array) {
                if(index === page) {
                    element.style.display = "block";
                    if(index !== 0)
                        window.history.pushState({page: index}, "", "?page=" + index);
                    else
                        window.location.href.substring(0, window.location.href.lastIndexOf('?'));
                } else {
                    element.style.display = "none";
                }
            });
        }

        window.addEventListener("DOMContentLoaded", function(event) {
            showPage();
        });
    </script>
</head>

<body>
    <h1>The puzzling MQ-x sensor series</h1>

    When choosing a gas sensor, there's nothing as cheap as an MQ-x series sensor. I decided to buy (for an incoming project) an MQ-7 and an MQ-135 for a grand total of 4.78&euro;. Let's see if I can make them work.

    <div id="page0" class="page">
        <h2>0. The working principle</h2>

        <img src="img/mq7.svg" loading="lazy" style="float:right;width:25%;">
        
        The MQ-7 sensitive layer is made of \(SnO_2\). In the presence of \(CO\) (the gas concentration we want to measure) the following reaction happens:
        \[{SnO_2}_{(s)} + 2CO_{(g)} \rightleftharpoons Sn_{(s)} + {2CO_2}_{(g)}\]

        This means that the more \(CO\) in the air, the more \(SnO_2\) gets converted to \(Sn\). I'm not a chemist, but usually the purer a metal is, the lower is its resistivity. In layman's terms: when the concentration of \(CO\) raises, the sensor sensitive layer resistance lowers.
        <br><br>
        The problem now is: what happens when all the \(SnO_2\) gets converted to \(Sn\)? Notice the double-sided arrow in the previous reaction, because it means it's reversibile.
        <br>
        Chemists defined the so-called <i>equilibrium constant</i> \(K_c\). When \(K_c>>1\) the reaction equilibrium is shifted to the right side of the equation, meaning that the predominant reaction is the one that gives us the products. The opposite happens if \(K_c&lt;&lt;1\). With this reaction we are in the first case, meaning that:
        <ul>
            <li>\(SnO_2\) is converted (with no effort) to \(Sn\)</li>
            <li>To reverse the reaction, we need to expend energy</li>
        </ul>
        That's where another sensor's element comes in handy: the heater. Again, I'm not a chemist, so don't quote me on this, but rising the sensor internal temperature means (probably) reversing the reaction, converting \(Sn\) back to \(SnO_2\).
        This is, in fact, supported by the fifth figure in the <a href="img/MQ-7.pdf">datasheet</a>:
        <img src="img/fig5.webp" loading="lazy" style="width: 90%;">

        To sum up, we need to:
        <ol>
            <li>Heat the heater at \(5V\)</li>
            <li>Wait \(60s\) to &quot;clean&quot; the sensor</li>
            <li>Drop the heater voltage at \(1.4V\)</li>
            <li>Keep that voltage steady for \(90s\)</li>
            <li>Read the sensor resistance right before the end of the \(90s\)-period</li>
        </ol>
    </div>

    <div id="page1" class="page">
        <h2>1. The dual voltage problem</h2>
        The first problem we need to face is the heater dual \(5V-1.4V\) voltage requirement. People decided to solve this issue by:
        <ol>
            <li>
                &#x274C; Using the <i>ostrich attitude</i>, <b>continuously providing \(5V\) to the heater</b>. 
                This is just utterly wrong: they are violating the sensor specs and that's bad.
            </li>
            <li>
                &#x274C; Generate a <b>PWM signal at \(1.4V\)</b> with Arduino.
                This is not wrong per se, but you need to be very careful if you choose this option because:
                <ul>
                    <li>The heater consumes \(70mA\) at \(5V\) and Arduino can't stand this much current</li>
                    <li>The heater needs a steady voltage, so the the PWM signal needs to be filtered</li>
                </ul>
            </li>
            <li>&#x2714; Use a custom circuit to switch between the two voltages</li>
        </ol>

        <h3>1.1. The real solution</h3>
        <img src="img/divider.svg" loading="lazy" style="float:right;width:45%;">
        We can grab the \(5V\) from the same power supply used for the Arduino, but what about the \(1.4V\) voltage? We can use a voltage divider:
        \[5V\frac{R_2}{R_1+R_2}=V_H=1.4V \Longrightarrow \frac{R_1}{R_2}\approx 2.57\]
        We know, from the <a href="img/MQ-7.pdf">datasheet</a>, that the heater has a resistance of \(33\Omega\). Hence, if we choose \(R_2=33\Omega\):
        \[R_1=2.57\cdot33\Omega\approx 85\Omega\]
        Which can be approximated to the closest standard value of \(82\Omega\). We also need \(V_H=5V\)! The solution is to simply short-circuit \(R_1\) with a transistor. We can use an nMOS since it has a much smaller \(R_{DS}\) than a BJT.
        <br><br>
        Now everything is fine, but we might want to switch the MOSFET on and off both from a \(5V\) board and a \(3.3V\) one. Unless we use some particular (read more expensive) MOSFET, we need a BJT, obtaining the circuit in the figure.
        I also added \(R_4\) to limit the base current of the BJT and \(R_3\) as a pullup resistor.
        <br><br>
        To sum up:
        <ul>
            <li>When the input is <b>high</b>, \(Q_1\) is &quot;on&quot;, \(M_1\) drain is held low, \(M_1\) is &quot;off&quot;, \(V_H=1.4V\)</li>
            <li>When the input is <b>low</b>, \(Q_1\) is &quot;off&quot;, \(M_1\) drain is held high, \(M_1\) is &quot;on&quot;, \(V_H=5V\)</li>
        </ul>
    </div>

    <div id="navigation-bar">
        <a href="#" onclick="prevPage();showPage();" id="navigate-left">&lt;&lt; Previous</a>
        <a href="#" onclick="nextPage();showPage();" id="navigate-right">Next &gt;&gt;</a>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/languages/c.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>